# ─────────────────────────────────────────────────────────────────────────────
# MyCoach — CI/CD Backend
# Pipeline : Tests → Build Docker → Push Docker Hub
# Déclencheur : push sur main ou pull request
#
# Secrets à configurer dans AppVeyor UI (Settings → Environment variables) :
#   DOCKER_PASSWORD      = dckr_pat_xxx…          (cocher "Encrypt value")
#   DOCKER_USERNAME      = blackbeardteam
# ─────────────────────────────────────────────────────────────────────────────

version: "{build}"

image: Ubuntu2204

# ─── Variables d'environnement ────────────────────────────────────────────────
environment:
  DOCKER_IMAGE: blackbeardteam/mycoach-api
  BACKEND_DIR: backend

  # DB de test
  DATABASE_URL: "postgresql+asyncpg://mycoach_ci:mycoach_ci_pass@localhost:5432/mycoach_test"

  # Clés CI (valeurs neutres — pas de données réelles)
  FIELD_ENCRYPTION_KEY: "E-t_tJ-aMju6zR2pDlVGW-7-Gd6AeUHQxFa_tf3hmX4="
  TOKEN_ENCRYPTION_KEY: "zVj1eWKXXxxes5SdBoDepwNZwOubLi9JecItFudSLPY="
  API_KEY_SALT: "1cb955941fd48ac254d90b5dcc660b1e"
  SECRET_KEY: "2d830c8e7b93b6e27164cdf07fd4fe76d31dcfb97d3c64451d8f27b5d2a83331"
  GOOGLE_CLIENT_ID: "ci_placeholder"
  APP_ENV: "test"

  # Docker Hub — à setter dans AppVeyor Settings > Environment (encryptés)
  DOCKER_USERNAME: "blackbeardteam"
  DOCKER_PASSWORD: ""

# ─── Service PostgreSQL (AppVeyor géré) ──────────────────────────────────────
services:
  - postgresql

# ─── Préparation ──────────────────────────────────────────────────────────────
install:
  # Python 3.12 (deadsnakes PPA — non disponible par défaut sur Ubuntu 22.04)
  - sudo add-apt-repository -y ppa:deadsnakes/ppa
  - sudo apt-get update -q
  - sudo apt-get install -y --no-install-recommends python3.12 python3.12-venv python3.12-dev gcc libpq-dev build-essential

  # PostgreSQL — démarrage + attente + user + DB + extensions
  - sudo service postgresql start || true
  - |
    for i in $(seq 1 20); do
      sudo -u postgres psql -c "SELECT 1" > /dev/null 2>&1 && break
      echo "Attente PostgreSQL... ($i/20)"
      sleep 2
    done
  - sudo -u postgres psql -c "CREATE USER mycoach_ci WITH PASSWORD 'mycoach_ci_pass';"
  - sudo -u postgres psql -c "CREATE DATABASE mycoach_test OWNER mycoach_ci;"
  - sudo -u postgres psql -d mycoach_test -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"
  - sudo -u postgres psql -d mycoach_test -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"
  - sudo -u postgres psql -d mycoach_test -c "CREATE EXTENSION IF NOT EXISTS unaccent;"

  # Venv Python
  - python3.12 -m venv backend/.venv
  - backend/.venv/bin/pip install --upgrade pip --quiet
  - backend/.venv/bin/pip install -r backend/requirements.txt --quiet
  - backend/.venv/bin/pip install -r backend/requirements-dev.txt --quiet

# ─── Build ───────────────────────────────────────────────────────────────────
build_script:
  - echo "=== Lint (ruff) ==="
  - backend/.venv/bin/python -m ruff check backend/app/ --output-format=github || true
  - echo "=== Typecheck (mypy) ==="
  - backend/.venv/bin/python -m mypy backend/app/ --ignore-missing-imports --no-error-summary || true

# ─── Tests ────────────────────────────────────────────────────────────────────
test_script:
  - |
    cd backend && PYTHONPATH=. .venv/bin/python -m pytest tests/ \
      -v --tb=short \
      --cov=app --cov-report=xml:coverage.xml --cov-report=term-missing \
      -x

# ─── Artifacts ────────────────────────────────────────────────────────────────
artifacts:
  - path: backend/coverage.xml
    name: coverage-report

# ─── Deploy (main uniquement) ─────────────────────────────────────────────────
deploy_script:
  - |
    set -e
    if [ "$APPVEYOR_REPO_BRANCH" = "main" ] && [ -z "$APPVEYOR_PULL_REQUEST_NUMBER" ]; then
      echo ">>> Branch main — build + push Docker Hub"

      if [ -z "$DOCKER_PASSWORD" ]; then
        echo "ERREUR : DOCKER_PASSWORD absent des settings AppVeyor"
        exit 1
      fi

      echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

      TAG_LATEST="${DOCKER_IMAGE}:latest"
      TAG_BUILD="${DOCKER_IMAGE}:build-${APPVEYOR_BUILD_NUMBER}"
      TAG_SHA="${DOCKER_IMAGE}:${APPVEYOR_REPO_COMMIT:0:8}"

      docker build \
        --label "build.number=${APPVEYOR_BUILD_NUMBER}" \
        --label "build.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
        --label "git.commit=${APPVEYOR_REPO_COMMIT:0:8}" \
        -t "$TAG_LATEST" -t "$TAG_BUILD" -t "$TAG_SHA" \
        ./backend/

      docker push "$TAG_LATEST"
      docker push "$TAG_BUILD"
      docker push "$TAG_SHA"

      echo "✅ Images publiées : $TAG_LATEST | $TAG_BUILD | $TAG_SHA"
    else
      echo ">>> Pas de push Docker (branch: $APPVEYOR_REPO_BRANCH)"
    fi
