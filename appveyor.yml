# ─────────────────────────────────────────────────────────────────────────────
# MyCoach — CI/CD Backend (appveyor.yml)
# ─────────────────────────────────────────────────────────────────────────────
#
# STRATÉGIE DE BRANCHE (mars 2025) :
#
#   TOUTES les branches :
#     → lint (ruff) + typecheck (mypy) + pytest
#     → docker build (sans push) — vérifie que l'image compile
#
#   main uniquement (hors PR) :
#     → push Docker Hub : blackbeardteam/mycoach-api:latest, :build-N, :sha
#     → C'est l'image de PRODUCTION
#
#   backend/* et dev (hors PR) :
#     → push Docker Hub : blackbeardteam/mycoach-api:dev, :branch-name
#     → Image de développement séparée, jamais :latest
#
# POURQUOI :
#   - Toutes les branches valident le build Docker → pas de surprise au merge
#   - :latest = toujours main = toujours prod-ready
#   - :dev = branche active de développement, utile pour staging/preview
#   - Les tags :branch-name permettent de tester une branche spécifique
#
# VARIABLES (AppVeyor UI, Settings → Environment, cocher "Encrypt value") :
#   DOCKER_USER          = blackbeardteam
#   DOCKER_PASS          = dckr_pat_xxx…
#   FIELD_ENCRYPTION_KEY = clé Fernet
#   TOKEN_ENCRYPTION_KEY = clé Fernet
#   API_KEY_SALT         = hex 16 bytes
#   SECRET_KEY           = hex 32 bytes
#   GOOGLE_CLIENT_ID     = ci_placeholder
# ─────────────────────────────────────────────────────────────────────────────

version: "{build}"

image: Ubuntu2204

# ─── Variables ────────────────────────────────────────────────────────────────
environment:
  DOCKER_IMAGE: blackbeardteam/mycoach-api
  DATABASE_URL: "postgresql+asyncpg://mycoach:mycoach_test@localhost:5432/mycoach_test"
  APP_ENV: "test"

# ─── Service PostgreSQL ───────────────────────────────────────────────────────
services:
  - postgresql

# ─── Installation ─────────────────────────────────────────────────────────────
install:
  - sudo add-apt-repository -y ppa:deadsnakes/ppa
  - sudo apt-get update -q
  - sudo apt-get install -y --no-install-recommends python3.12 python3.12-venv python3.12-dev gcc libpq-dev build-essential

  - sudo service postgresql start || true
  - |
    for i in $(seq 1 20); do
      sudo -u postgres psql -c "SELECT 1" > /dev/null 2>&1 && break
      echo "Attente PostgreSQL... ($i/20)"; sleep 2
    done

  - sudo -u postgres psql -c "CREATE USER mycoach WITH PASSWORD 'mycoach_test';"
  - sudo -u postgres psql -c "CREATE DATABASE mycoach_test OWNER mycoach;"
  - sudo -u postgres psql -d mycoach_test -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"
  - sudo -u postgres psql -d mycoach_test -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"
  - sudo -u postgres psql -d mycoach_test -c "CREATE EXTENSION IF NOT EXISTS unaccent;"

  - python3.12 -m venv backend/.venv
  - backend/.venv/bin/pip install --upgrade pip --quiet
  - backend/.venv/bin/pip install -r backend/requirements.txt --quiet
  - backend/.venv/bin/pip install -r backend/requirements-dev.txt --quiet

# ─── Build (lint + typecheck) ─────────────────────────────────────────────────
build_script:
  - backend/.venv/bin/python -m ruff check backend/app/ --output-format=github || true
  - backend/.venv/bin/python -m mypy backend/app/ --ignore-missing-imports --no-error-summary || true

# ─── Tests ────────────────────────────────────────────────────────────────────
test_script:
  - cd backend && PYTHONPATH=. .venv/bin/python -m pytest tests/ -v --tb=short --cov=app --cov-report=xml:coverage.xml -x

# ─── Artifacts ────────────────────────────────────────────────────────────────
artifacts:
  - path: backend/coverage.xml
    name: coverage-report

# ─── Docker Build + Push (conditionnel par branche) ───────────────────────────
deploy_script:
  - |
    set -e
    BRANCH="$APPVEYOR_REPO_BRANCH"
    IS_PR="${APPVEYOR_PULL_REQUEST_NUMBER}"
    SHORT_SHA="${APPVEYOR_REPO_COMMIT:0:8}"

    echo "=== Docker Build (toutes branches) ==="
    cd "$APPVEYOR_BUILD_FOLDER"
    docker build \
      --label "build.number=${APPVEYOR_BUILD_NUMBER}" \
      --label "build.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
      --label "git.commit=${SHORT_SHA}" \
      --label "git.branch=${BRANCH}" \
      -t "${DOCKER_IMAGE}:ci-${APPVEYOR_BUILD_NUMBER}" \
      ./backend/

    echo "✅ Docker build OK (branch: $BRANCH)"

    # ── Pas de push sur les PR ──
    if [ -n "$IS_PR" ]; then
      echo ">>> PR détectée — pas de push Docker"
      exit 0
    fi

    # ── Push : main → production tags ──
    if [ "$BRANCH" = "main" ]; then
      echo "=== Push Docker Hub (PRODUCTION) ==="

      if [ -z "$DOCKER_PASS" ]; then
        echo "ERREUR : DOCKER_PASS absent des settings AppVeyor"
        exit 1
      fi
      echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

      docker tag "${DOCKER_IMAGE}:ci-${APPVEYOR_BUILD_NUMBER}" "${DOCKER_IMAGE}:latest"
      docker tag "${DOCKER_IMAGE}:ci-${APPVEYOR_BUILD_NUMBER}" "${DOCKER_IMAGE}:build-${APPVEYOR_BUILD_NUMBER}"
      docker tag "${DOCKER_IMAGE}:ci-${APPVEYOR_BUILD_NUMBER}" "${DOCKER_IMAGE}:${SHORT_SHA}"

      docker push "${DOCKER_IMAGE}:latest"
      docker push "${DOCKER_IMAGE}:build-${APPVEYOR_BUILD_NUMBER}"
      docker push "${DOCKER_IMAGE}:${SHORT_SHA}"

      echo "✅ Images PROD publiées : :latest :build-${APPVEYOR_BUILD_NUMBER} :${SHORT_SHA}"

    # ── Push : backend/* ou dev → dev tags ──
    elif echo "$BRANCH" | grep -qE '^(backend/|dev$)'; then
      echo "=== Push Docker Hub (DEV) ==="

      if [ -z "$DOCKER_PASS" ]; then
        echo "ERREUR : DOCKER_PASS absent des settings AppVeyor"
        exit 1
      fi
      echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

      # Sanitize branch name for Docker tag (replace / with -)
      BRANCH_TAG=$(echo "$BRANCH" | sed 's|/|-|g')

      docker tag "${DOCKER_IMAGE}:ci-${APPVEYOR_BUILD_NUMBER}" "${DOCKER_IMAGE}:dev"
      docker tag "${DOCKER_IMAGE}:ci-${APPVEYOR_BUILD_NUMBER}" "${DOCKER_IMAGE}:${BRANCH_TAG}"

      docker push "${DOCKER_IMAGE}:dev"
      docker push "${DOCKER_IMAGE}:${BRANCH_TAG}"

      echo "✅ Images DEV publiées : :dev :${BRANCH_TAG}"

    else
      echo ">>> Branche '$BRANCH' — build OK, pas de push Docker"
    fi
