# ─────────────────────────────────────────────────────────────────────────────
# MyCoach — CI/CD Backend
# Pipeline : Tests → Build Docker → Push Docker Hub
#
# Variables à configurer dans AppVeyor UI (Settings → Environment variables) :
#   DOCKER_USER          = blackbeardteam           (cocher "Encrypt value")
#   DOCKER_PASS          = dckr_pat_xxx…            (cocher "Encrypt value")
#   FIELD_ENCRYPTION_KEY = clé Fernet               (cocher "Encrypt value")
#   TOKEN_ENCRYPTION_KEY = clé Fernet               (cocher "Encrypt value")
#   API_KEY_SALT         = hex 16 bytes             (cocher "Encrypt value")
#   SECRET_KEY           = hex 32 bytes             (cocher "Encrypt value")
#
# Variables PAS dans l'UI (gérées ici) :
#   DATABASE_URL, GOOGLE_CLIENT_ID, APP_ENV
# ─────────────────────────────────────────────────────────────────────────────

version: "{build}"

image: Ubuntu2204

# ─── Variables ────────────────────────────────────────────────────────────────
environment:
  DOCKER_IMAGE: blackbeardteam/mycoach-api

  # DB de test — doit correspondre exactement à pyproject.toml [tool.pytest.ini_options].env
  DATABASE_URL: "postgresql+asyncpg://mycoach:mycoach_test@localhost:5432/mycoach_test"

  # Valeurs CI neutres — les vraies valeurs dans l'UI AppVeyor prennent la priorité
  GOOGLE_CLIENT_ID: "ci_placeholder"
  APP_ENV: "test"

# ─── Service PostgreSQL ───────────────────────────────────────────────────────
services:
  - postgresql

# ─── Installation ─────────────────────────────────────────────────────────────
install:
  # Python 3.12 (deadsnakes PPA)
  - sudo add-apt-repository -y ppa:deadsnakes/ppa
  - sudo apt-get update -q
  - sudo apt-get install -y --no-install-recommends python3.12 python3.12-venv python3.12-dev gcc libpq-dev build-essential

  # PostgreSQL — démarrage + attente
  - sudo service postgresql start || true
  - |
    for i in $(seq 1 20); do
      sudo -u postgres psql -c "SELECT 1" > /dev/null 2>&1 && break
      echo "Attente PostgreSQL... ($i/20)"; sleep 2
    done

  # Créer user + DB + extensions (credentials = pyproject.toml)
  - sudo -u postgres psql -c "CREATE USER mycoach WITH PASSWORD 'mycoach_test';"
  - sudo -u postgres psql -c "CREATE DATABASE mycoach_test OWNER mycoach;"
  - sudo -u postgres psql -d mycoach_test -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"
  - sudo -u postgres psql -d mycoach_test -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"
  - sudo -u postgres psql -d mycoach_test -c "CREATE EXTENSION IF NOT EXISTS unaccent;"

  # Venv Python + dépendances
  - python3.12 -m venv backend/.venv
  - backend/.venv/bin/pip install --upgrade pip --quiet
  - backend/.venv/bin/pip install -r backend/requirements.txt --quiet
  - backend/.venv/bin/pip install -r backend/requirements-dev.txt --quiet

# ─── Build (lint + typecheck, non bloquants) ──────────────────────────────────
build_script:
  - backend/.venv/bin/python -m ruff check backend/app/ --output-format=github || true
  - backend/.venv/bin/python -m mypy backend/app/ --ignore-missing-imports --no-error-summary || true

# ─── Tests ────────────────────────────────────────────────────────────────────
test_script:
  - cd backend && PYTHONPATH=. .venv/bin/python -m pytest tests/ -v --tb=short --cov=app --cov-report=xml:coverage.xml -x

# ─── Artifacts ────────────────────────────────────────────────────────────────
artifacts:
  - path: backend/coverage.xml
    name: coverage-report

# ─── Deploy Docker Hub (main uniquement, après tests verts) ───────────────────
deploy_script:
  - |
    set -e
    if [ "$APPVEYOR_REPO_BRANCH" = "main" ] && [ -z "$APPVEYOR_PULL_REQUEST_NUMBER" ]; then
      echo "=== Build + Push Docker Hub ==="

      if [ -z "$DOCKER_PASS" ]; then
        echo "ERREUR : DOCKER_PASS absent des settings AppVeyor"
        exit 1
      fi

      echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

      TAG_LATEST="${DOCKER_IMAGE}:latest"
      TAG_BUILD="${DOCKER_IMAGE}:build-${APPVEYOR_BUILD_NUMBER}"
      TAG_SHA="${DOCKER_IMAGE}:${APPVEYOR_REPO_COMMIT:0:8}"

      docker build \
        --label "build.number=${APPVEYOR_BUILD_NUMBER}" \
        --label "build.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
        --label "git.commit=${APPVEYOR_REPO_COMMIT:0:8}" \
        -t "$TAG_LATEST" -t "$TAG_BUILD" -t "$TAG_SHA" \
        ./backend/

      docker push "$TAG_LATEST"
      docker push "$TAG_BUILD"
      docker push "$TAG_SHA"

      echo "✅ Images publiées :"
      echo "   $TAG_LATEST"
      echo "   $TAG_BUILD"
      echo "   $TAG_SHA"
    else
      echo ">>> Pas de push Docker (branch: $APPVEYOR_REPO_BRANCH)"
    fi
