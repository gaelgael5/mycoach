<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MyCoach</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f0f4f8;color:#1a202c;min-height:100vh}

/* Nav */
nav{background:#2d3748;color:#fff;padding:0 24px;display:flex;align-items:center;gap:24px;height:56px;position:sticky;top:0;z-index:100}
nav .logo{font-size:20px;font-weight:700;color:#fff;text-decoration:none}
nav a{color:#a0aec0;text-decoration:none;font-size:14px;font-weight:500;padding:6px 12px;border-radius:6px;transition:.2s}
nav a:hover,nav a.active{color:#fff;background:#4a5568}

/* Main */
main{max-width:1100px;margin:0 auto;padding:24px 16px}

/* Dashboard cards */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:32px}
.stat-card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.stat-card .label{font-size:12px;color:#718096;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.stat-card .value{font-size:28px;font-weight:700;color:#2d3748;margin-top:6px}
.stat-card .value.green{color:#38a169}
.stat-card .value.red{color:#e53e3e}
.stat-card .value.blue{color:#3182ce}

/* Section */
.section{background:#fff;border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin-bottom:24px}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.section-title{font-size:18px;font-weight:700;color:#2d3748}

/* Buttons */
.btn{padding:8px 16px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:#3182ce;color:#fff}.btn-primary:hover{background:#2c5282}
.btn-success{background:#38a169;color:#fff}.btn-success:hover{background:#2f855a}
.btn-danger{background:#e53e3e;color:#fff}.btn-danger:hover{background:#c53030}
.btn-ghost{background:transparent;color:#718096;border:1px solid #e2e8f0}.btn-ghost:hover{background:#f7fafc}
.btn-sm{padding:5px 10px;font-size:12px}

/* Table */
table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:12px;font-weight:600;color:#718096;text-transform:uppercase;letter-spacing:.5px;padding:8px 12px;border-bottom:2px solid #e2e8f0}
td{padding:12px;border-bottom:1px solid #f7fafc;font-size:14px}
tr:hover td{background:#f7fafc}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:600}
.badge-green{background:#c6f6d5;color:#276749}
.badge-red{background:#fed7d7;color:#9b2c2c}
.badge-blue{background:#bee3f8;color:#2a4365}

/* Modal */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:#fff;border-radius:12px;padding:28px;width:90%;max-width:480px;max-height:90vh;overflow-y:auto}
.modal h3{font-size:18px;font-weight:700;margin-bottom:20px;color:#2d3748}

/* Form */
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;font-weight:600;color:#4a5568;margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;background:#fff;color:#2d3748;transition:.2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#3182ce;box-shadow:0 0 0 3px rgba(49,130,206,.1)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Tabs */
.page{display:none}.page.active{display:block}

/* Empty state */
.empty{text-align:center;padding:48px;color:#a0aec0}
.empty-icon{font-size:48px;margin-bottom:12px}

/* Responsive */
@media(max-width:600px){
  .form-row{grid-template-columns:1fr}
  .stats{grid-template-columns:1fr 1fr}
  nav{gap:8px}
  nav a{padding:6px 8px;font-size:13px}
}
</style>
</head>
<body>

<nav>
  <span class="logo">üèãÔ∏è MyCoach</span>
  <a href="#" class="active" onclick="showPage('dashboard',this)">Dashboard</a>
  <a href="#" onclick="showPage('clients',this)">Clients</a>
  <a href="#" onclick="showPage('sessions',this)">S√©ances</a>
  <a href="#" onclick="showPage('payments',this)">Paiements</a>
  <a href="#" onclick="showPage('schedule',this)">üìÖ Emploi du temps</a>
</nav>

<main>

<!-- DASHBOARD -->
<div id="page-dashboard" class="page active">
  <div class="stats" id="stats-grid">
    <div class="stat-card"><div class="label">Clients</div><div class="value blue" id="stat-clients">‚Äî</div></div>
    <div class="stat-card"><div class="label">S√©ances</div><div class="value blue" id="stat-sessions">‚Äî</div></div>
    <div class="stat-card"><div class="label">Heures totales</div><div class="value" id="stat-hours">‚Äî</div></div>
    <div class="stat-card"><div class="label">Factur√©</div><div class="value green" id="stat-revenue">‚Äî</div></div>
    <div class="stat-card"><div class="label">Encaiss√©</div><div class="value green" id="stat-paid">‚Äî</div></div>
    <div class="stat-card"><div class="label">Impay√©</div><div class="value red" id="stat-outstanding">‚Äî</div></div>
  </div>

  <div class="section">
    <div class="section-header"><h2 class="section-title">Clients r√©cents</h2></div>
    <table><thead><tr><th>Nom</th><th>Heures</th><th>Factur√©</th><th>Encaiss√©</th><th>Solde</th></tr></thead>
    <tbody id="dashboard-clients"></tbody></table>
  </div>
</div>

<!-- CLIENTS -->
<div id="page-clients" class="page">
  <div class="section">
    <div class="section-header">
      <h2 class="section-title">Clients</h2>
      <button class="btn btn-primary" onclick="openClientModal()">+ Nouveau client</button>
    </div>
    <table><thead><tr><th>Nom</th><th>Email</th><th>T√©l√©phone</th><th>Tarif/h</th><th>Heures</th><th>Solde</th><th></th></tr></thead>
    <tbody id="clients-table"></tbody></table>
  </div>
</div>

<!-- SESSIONS -->
<div id="page-sessions" class="page">
  <div class="section">
    <div class="section-header">
      <h2 class="section-title">S√©ances</h2>
      <button class="btn btn-primary" onclick="openSessionModal()">+ Nouvelle s√©ance</button>
    </div>
    <table><thead><tr><th>Date</th><th>Client</th><th>Dur√©e</th><th>Montant</th><th>Notes</th><th></th></tr></thead>
    <tbody id="sessions-table"></tbody></table>
  </div>
</div>

<!-- PAYMENTS -->
<div id="page-payments" class="page">
  <div class="section">
    <div class="section-header">
      <h2 class="section-title">Paiements</h2>
      <button class="btn btn-primary" onclick="openPaymentModal()">+ Enregistrer un paiement</button>
    </div>
    <table><thead><tr><th>Date</th><th>Client</th><th>Montant</th><th>M√©thode</th><th>Notes</th><th></th></tr></thead>
    <tbody id="payments-table"></tbody></table>
  </div>
</div>

<!-- SCHEDULE -->
<div id="page-schedule" class="page">

  <!-- Not connected banner -->
  <div id="gcal-connect-banner" class="section" style="text-align:center;padding:40px;display:none">
    <div style="font-size:48px;margin-bottom:12px">üìÖ</div>
    <h3 style="font-size:20px;font-weight:700;margin-bottom:8px;color:#2d3748">Connecter Google Calendar</h3>
    <p style="color:#718096;margin-bottom:24px">Synchronisez vos s√©ances avec votre Google Calendar pour g√©rer votre emploi du temps.</p>
    <a href="/auth/google-calendar" class="btn btn-primary" style="text-decoration:none">Connecter Google Calendar</a>
  </div>

  <!-- Connected view -->
  <div id="gcal-connected-view" style="display:none">
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Emploi du temps</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <span id="gcal-status-badge" class="badge badge-green">‚úÖ Google Calendar connect√©</span>
          <button class="btn btn-primary btn-sm" onclick="openEventModal()">+ Cr√©er un √©v√©nement</button>
          <button class="btn btn-ghost btn-sm" onclick="refreshEvents()">üîÑ</button>
          <button class="btn btn-danger btn-sm" onclick="disconnectCalendar()">D√©connecter</button>
        </div>
      </div>

      <!-- Upcoming events -->
      <div id="events-list" style="display:grid;gap:10px;margin-top:8px"></div>
    </div>

    <!-- Embed Google Calendar -->
    <div class="section" style="padding:0;overflow:hidden;border-radius:12px">
      <iframe id="gcal-embed" src="" style="width:100%;height:600px;border:none;display:block" frameborder="0" scrolling="no"></iframe>
    </div>
  </div>

</div>

</main>

<!-- MODALS -->

<!-- Event modal -->
<div class="modal-bg" id="event-modal">
  <div class="modal">
    <h3>Cr√©er un √©v√©nement</h3>
    <div class="form-group"><label>Titre *</label><input id="ev-title" placeholder="S√©ance coaching ‚Äî Jean Dupont"/></div>
    <div class="form-row">
      <div class="form-group"><label>Date et heure *</label><input id="ev-start" type="datetime-local"/></div>
      <div class="form-group"><label>Dur√©e (minutes)</label><input id="ev-duration" type="number" value="60" min="15" step="15"/></div>
    </div>
    <div class="form-group"><label>Client (optionnel)</label>
      <select id="ev-client">
        <option value="">‚Äî Aucun ‚Äî</option>
      </select>
    </div>
    <div class="form-group"><label>Description</label><textarea id="ev-desc" rows="2"></textarea></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn btn-ghost" onclick="closeModal('event-modal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveEvent()">Cr√©er dans Google Calendar</button>
    </div>
  </div>
</div>

<!-- Client modal -->
<div class="modal-bg" id="client-modal">
  <div class="modal">
    <h3 id="client-modal-title">Nouveau client</h3>
    <input type="hidden" id="client-id"/>
    <div class="form-group"><label>Nom *</label><input id="c-name" placeholder="Jean Dupont"/></div>
    <div class="form-row">
      <div class="form-group"><label>Email</label><input id="c-email" type="email" placeholder="jean@mail.com"/></div>
      <div class="form-group"><label>T√©l√©phone</label><input id="c-phone" placeholder="06 12 34 56 78"/></div>
    </div>
    <div class="form-group"><label>Tarif horaire (‚Ç¨)</label><input id="c-rate" type="number" step="0.01" placeholder="60"/></div>
    <div class="form-group"><label>Notes</label><textarea id="c-notes" rows="2" placeholder="Objectifs, niveau..."></textarea></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn btn-ghost" onclick="closeModal('client-modal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveClient()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Session modal -->
<div class="modal-bg" id="session-modal">
  <div class="modal">
    <h3>Nouvelle s√©ance</h3>
    <div class="form-group"><label>Client *</label><select id="s-client"></select></div>
    <div class="form-row">
      <div class="form-group"><label>Date *</label><input id="s-date" type="date"/></div>
      <div class="form-group"><label>Dur√©e (minutes) *</label><input id="s-duration" type="number" value="60" min="15" step="15"/></div>
    </div>
    <div class="form-group"><label>Notes</label><textarea id="s-notes" rows="2" placeholder="Contenu de la s√©ance..."></textarea></div>
    <div class="form-group" style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" id="s-billed" checked style="width:auto"/>
      <label for="s-billed" style="margin:0;cursor:pointer">Facturer cette s√©ance</label>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn btn-ghost" onclick="closeModal('session-modal')">Annuler</button>
      <button class="btn btn-success" onclick="saveSession()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Payment modal -->
<div class="modal-bg" id="payment-modal">
  <div class="modal">
    <h3>Enregistrer un paiement</h3>
    <div class="form-group"><label>Client *</label><select id="p-client"></select></div>
    <div class="form-row">
      <div class="form-group"><label>Date *</label><input id="p-date" type="date"/></div>
      <div class="form-group"><label>Montant (‚Ç¨) *</label><input id="p-amount" type="number" step="0.01" placeholder="150"/></div>
    </div>
    <div class="form-group"><label>M√©thode</label>
      <select id="p-method">
        <option value="">‚Äî Choisir ‚Äî</option>
        <option>Virement</option><option>Esp√®ces</option><option>Carte</option><option>Ch√®que</option><option>PayPal</option>
      </select>
    </div>
    <div class="form-group"><label>Notes</label><textarea id="p-notes" rows="2"></textarea></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn btn-ghost" onclick="closeModal('payment-modal')">Annuler</button>
      <button class="btn btn-success" onclick="savePayment()">Enregistrer</button>
    </div>
  </div>
</div>

<script>
const API = '';

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(name, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (el) el.classList.add('active');
  if (name === 'dashboard') loadDashboard();
  if (name === 'clients') loadClients();
  if (name === 'sessions') loadSessions();
  if (name === 'payments') loadPayments();
  if (name === 'schedule') loadSchedule();
}

// ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(path, method='GET', body=null) {
  const opts = { method, headers: {'Content-Type':'application/json'} };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(API + path, opts);
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

const fmt = (n) => new Intl.NumberFormat('fr-FR', {style:'currency',currency:'EUR'}).format(n||0);
const fmtH = (h) => h % 1 === 0 ? h + 'h' : h.toFixed(1) + 'h';

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDashboard() {
  const stats = await api('/api/dashboard');
  document.getElementById('stat-clients').textContent = stats.total_clients;
  document.getElementById('stat-sessions').textContent = stats.total_sessions;
  document.getElementById('stat-hours').textContent = fmtH(stats.total_hours);
  document.getElementById('stat-revenue').textContent = fmt(stats.total_revenue);
  document.getElementById('stat-paid').textContent = fmt(stats.total_paid);
  const outstanding = document.getElementById('stat-outstanding');
  outstanding.textContent = fmt(stats.total_outstanding);

  const clients = await api('/api/clients');
  const tbody = document.getElementById('dashboard-clients');
  tbody.innerHTML = clients.slice(0,8).map(c => `
    <tr>
      <td><strong>${c.name}</strong></td>
      <td>${fmtH(c.total_hours||0)}</td>
      <td>${fmt(c.total_revenue)}</td>
      <td>${fmt(c.total_paid)}</td>
      <td><span class="badge ${c.balance>0?'badge-red':'badge-green'}">${fmt(c.balance)}</span></td>
    </tr>`).join('') || '<tr><td colspan="5" class="empty">Aucun client</td></tr>';
}

// ‚îÄ‚îÄ Clients ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadClients() {
  const clients = await api('/api/clients');
  const tbody = document.getElementById('clients-table');
  tbody.innerHTML = clients.map(c => `
    <tr>
      <td><strong>${c.name}</strong></td>
      <td>${c.email||'‚Äî'}</td>
      <td>${c.phone||'‚Äî'}</td>
      <td>${c.hourly_rate ? fmt(c.hourly_rate)+'/h' : '‚Äî'}</td>
      <td>${fmtH(c.total_hours||0)}</td>
      <td><span class="badge ${c.balance>0?'badge-red':c.balance<0?'badge-blue':'badge-green'}">${fmt(c.balance)}</span></td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick="editClient(${c.id})">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-sm" onclick="delClient(${c.id})">üóëÔ∏è</button>
      </td>
    </tr>`).join('') || '<tr><td colspan="7"><div class="empty"><div class="empty-icon">üë§</div>Aucun client ‚Äî ajoutez-en un !</div></td></tr>';
}

function openClientModal(id) {
  document.getElementById('client-id').value = '';
  document.getElementById('client-modal-title').textContent = 'Nouveau client';
  ['c-name','c-email','c-phone','c-rate','c-notes'].forEach(id => document.getElementById(id).value='');
  document.getElementById('client-modal').classList.add('open');
}

async function editClient(id) {
  const c = await api('/api/clients/' + id);
  document.getElementById('client-id').value = id;
  document.getElementById('client-modal-title').textContent = 'Modifier ' + c.name;
  document.getElementById('c-name').value = c.name||'';
  document.getElementById('c-email').value = c.email||'';
  document.getElementById('c-phone').value = c.phone||'';
  document.getElementById('c-rate').value = c.hourly_rate||'';
  document.getElementById('c-notes').value = c.notes||'';
  document.getElementById('client-modal').classList.add('open');
}

async function saveClient() {
  const id = document.getElementById('client-id').value;
  const data = {
    name: document.getElementById('c-name').value,
    email: document.getElementById('c-email').value||null,
    phone: document.getElementById('c-phone').value||null,
    hourly_rate: parseFloat(document.getElementById('c-rate').value)||0,
    notes: document.getElementById('c-notes').value||null
  };
  if (!data.name) { alert('Le nom est requis'); return; }
  if (id) await api('/api/clients/'+id, 'PUT', data);
  else await api('/api/clients', 'POST', data);
  closeModal('client-modal');
  loadClients();
}

async function delClient(id) {
  if (!confirm('Supprimer ce client ?')) return;
  await api('/api/clients/'+id, 'DELETE');
  loadClients();
}

// ‚îÄ‚îÄ Sessions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadSessions() {
  const sessions = await api('/api/sessions');
  const tbody = document.getElementById('sessions-table');
  tbody.innerHTML = sessions.map(s => `
    <tr>
      <td>${s.date}</td>
      <td>${s.client_name}</td>
      <td>${s.duration_minutes >= 60 ? Math.floor(s.duration_minutes/60)+'h'+(s.duration_minutes%60?s.duration_minutes%60+'m':'') : s.duration_minutes+'min'}</td>
      <td>${s.billed ? fmt(s.amount) : '<span class="badge badge-blue">Non factur√©</span>'}</td>
      <td style="color:#718096;font-size:13px">${s.notes||''}</td>
      <td><button class="btn btn-danger btn-sm" onclick="delSession(${s.id})">üóëÔ∏è</button></td>
    </tr>`).join('') || '<tr><td colspan="6"><div class="empty"><div class="empty-icon">‚è±Ô∏è</div>Aucune s√©ance</div></td></tr>';
}

async function openSessionModal() {
  const clients = await api('/api/clients');
  const sel = document.getElementById('s-client');
  sel.innerHTML = clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('s-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('s-duration').value = 60;
  document.getElementById('s-notes').value = '';
  document.getElementById('s-billed').checked = true;
  document.getElementById('session-modal').classList.add('open');
}

async function saveSession() {
  const data = {
    client_id: parseInt(document.getElementById('s-client').value),
    date: document.getElementById('s-date').value,
    duration_minutes: parseInt(document.getElementById('s-duration').value),
    notes: document.getElementById('s-notes').value||null,
    billed: document.getElementById('s-billed').checked
  };
  await api('/api/sessions', 'POST', data);
  closeModal('session-modal');
  loadSessions();
}

async function delSession(id) {
  if (!confirm('Supprimer cette s√©ance ?')) return;
  await api('/api/sessions/'+id, 'DELETE');
  loadSessions();
}

// ‚îÄ‚îÄ Payments ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadPayments() {
  const payments = await api('/api/payments');
  const tbody = document.getElementById('payments-table');
  tbody.innerHTML = payments.map(p => `
    <tr>
      <td>${p.date}</td>
      <td>${p.client_name}</td>
      <td><strong class="badge badge-green">${fmt(p.amount)}</strong></td>
      <td>${p.method||'‚Äî'}</td>
      <td style="color:#718096;font-size:13px">${p.notes||''}</td>
      <td><button class="btn btn-danger btn-sm" onclick="delPayment(${p.id})">üóëÔ∏è</button></td>
    </tr>`).join('') || '<tr><td colspan="6"><div class="empty"><div class="empty-icon">üí≥</div>Aucun paiement</div></td></tr>';
}

async function openPaymentModal() {
  const clients = await api('/api/clients');
  const sel = document.getElementById('p-client');
  sel.innerHTML = clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('p-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('p-amount').value = '';
  document.getElementById('p-method').value = '';
  document.getElementById('p-notes').value = '';
  document.getElementById('payment-modal').classList.add('open');
}

async function savePayment() {
  const data = {
    client_id: parseInt(document.getElementById('p-client').value),
    date: document.getElementById('p-date').value,
    amount: parseFloat(document.getElementById('p-amount').value),
    method: document.getElementById('p-method').value||null,
    notes: document.getElementById('p-notes').value||null
  };
  if (!data.amount) { alert('Le montant est requis'); return; }
  await api('/api/payments', 'POST', data);
  closeModal('payment-modal');
  loadPayments();
}

async function delPayment(id) {
  if (!confirm('Supprimer ce paiement ?')) return;
  await api('/api/payments/'+id, 'DELETE');
  loadPayments();
}

// ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
document.querySelectorAll('.modal-bg').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

// ‚îÄ‚îÄ Google Calendar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadSchedule() {
  const status = await api('/api/calendar/status');

  if (!status.connected) {
    document.getElementById('gcal-connect-banner').style.display = 'block';
    document.getElementById('gcal-connected-view').style.display = 'none';
    return;
  }

  document.getElementById('gcal-connect-banner').style.display = 'none';
  document.getElementById('gcal-connected-view').style.display = 'block';

  // Embed Google Calendar (public view)
  const embed = document.getElementById('gcal-embed');
  if (!embed.src) {
    embed.src = 'https://calendar.google.com/calendar/embed?showTitle=0&showNav=1&showDate=1&showPrint=0&showCalendars=0&mode=WEEK&hl=fr';
  }

  refreshEvents();
}

async function refreshEvents() {
  try {
    const events = await api('/api/calendar/events?days=14');
    const container = document.getElementById('events-list');

    if (events.length === 0) {
      container.innerHTML = '<p style="color:#a0aec0;text-align:center;padding:24px">Aucun √©v√©nement dans les 14 prochains jours</p>';
      return;
    }

    container.innerHTML = events.map(e => {
      const start = new Date(e.start);
      const end   = new Date(e.end);
      const dateStr = start.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric', month:'short'});
      const timeStr = start.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}) + ' ‚Äì ' + end.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
      return `
        <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:#f7fafc;border-radius:10px;border-left:4px solid #3182ce">
          <div style="min-width:90px;text-align:center">
            <div style="font-size:13px;font-weight:700;color:#3182ce">${dateStr}</div>
            <div style="font-size:12px;color:#718096">${timeStr}</div>
          </div>
          <div style="flex:1">
            <div style="font-weight:600;color:#2d3748">${e.title}</div>
            ${e.description ? `<div style="font-size:12px;color:#718096;margin-top:2px">${e.description}</div>` : ''}
          </div>
          <div style="display:flex;gap:6px">
            <a href="${e.html_link}" target="_blank" class="btn btn-ghost btn-sm" title="Ouvrir dans Google Calendar">‚Üó</a>
            <button class="btn btn-danger btn-sm" onclick="deleteEvent('${e.id}')" title="Supprimer">üóëÔ∏è</button>
          </div>
        </div>`;
    }).join('');
  } catch (err) {
    document.getElementById('events-list').innerHTML = `<p style="color:#e53e3e">Erreur: ${err.message}</p>`;
  }
}

async function openEventModal() {
  const clients = await api('/api/clients');
  const sel = document.getElementById('ev-client');
  sel.innerHTML = '<option value="">‚Äî Aucun ‚Äî</option>' + clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

  // Default: now, rounded to next 30min
  const now = new Date();
  now.setMinutes(Math.ceil(now.getMinutes()/30)*30, 0, 0);
  document.getElementById('ev-start').value = now.toISOString().slice(0,16);
  document.getElementById('ev-duration').value = 60;
  document.getElementById('ev-title').value = '';
  document.getElementById('ev-desc').value = '';
  document.getElementById('event-modal').classList.add('open');
}

async function saveEvent() {
  const clientId = document.getElementById('ev-client').value;
  let title = document.getElementById('ev-title').value.trim();
  const start = document.getElementById('ev-start').value;
  const duration = parseInt(document.getElementById('ev-duration').value);
  const desc = document.getElementById('ev-desc').value;

  if (!title) { alert('Le titre est requis'); return; }
  if (!start)  { alert('La date est requise'); return; }

  // Auto-prefix with client name if selected
  if (clientId) {
    const clients = await api('/api/clients');
    const client = clients.find(c => c.id == clientId);
    if (client && !title.includes(client.name)) {
      title = `${title} ‚Äî ${client.name}`;
    }
  }

  try {
    const ev = await api('/api/calendar/events', 'POST', {
      title, start, duration_minutes: duration, description: desc
    });
    closeModal('event-modal');
    refreshEvents();
    // Also reload calendar embed
    const embed = document.getElementById('gcal-embed');
    embed.src = embed.src;
  } catch (err) {
    alert('Erreur: ' + err.message);
  }
}

async function deleteEvent(eventId) {
  if (!confirm('Supprimer cet √©v√©nement de Google Calendar ?')) return;
  await api('/api/calendar/events/' + eventId, 'DELETE');
  refreshEvents();
}

async function disconnectCalendar() {
  if (!confirm('D√©connecter Google Calendar ?')) return;
  await api('/api/calendar/disconnect', 'DELETE');
  loadSchedule();
}

// Check URL params on load (after OAuth redirect)
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('calendar') === 'connected') {
  showPage('schedule', document.querySelector('nav a:last-child'));
  history.replaceState({}, '', '/');
}

// Init
loadDashboard();
</script>
</body>
</html>
